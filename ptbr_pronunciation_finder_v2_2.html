<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PT-BR Pronunciation Finder — v2.2 (Hosted Dataset)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .line-clamp-3 {display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
    .mono {font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .badge { font-size: 11px; padding: 2px 8px; border-radius: 9999px; border: 1px solid rgba(255,255,255,0.12); }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <header class="flex items-center justify-between mb-6 gap-3 flex-wrap">
      <div>
        <h1 class="text-2xl font-bold">PT-BR Pronunciation Finder <span class="text-xs text-slate-400">v2.2</span></h1>
        <p class="text-sm text-slate-400">Carrega dataset hospedado automaticamente (manifest + shards) ou via importação manual.</p>
      </div>
      <div class="flex gap-2">
        <button id="btnImport" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-sm">Importar arquivos</button>
        <input type="file" id="fileInput" class="hidden" multiple accept=".vtt,.srt,.json" />
        <button id="btnExport" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm">Exportar índice</button>
        <button id="btnClear" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm">Limpar</button>
      </div>
    </header>

    <section class="mb-4">
      <div class="grid md:grid-cols-3 gap-3">
        <div class="md:col-span-2 flex items-center gap-2">
          <input id="searchBox" type="text" placeholder="Buscar (ex.: Kael'thas, Varok, ‘Sylvanas’)..."
            class="w-full px-4 py-3 rounded-2xl bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-600" />
          <button id="btnSearch" class="px-4 py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Buscar</button>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
          <label class="flex items-center gap-2 text-sm text-slate-300">
            <input id="exactMatch" type="checkbox" class="accent-indigo-600" />
            Coincidência exata
          </label>
          <label class="flex items-center gap-2 text-sm text-slate-300">
            <input id="strictPT" type="checkbox" class="accent-indigo-600" />
            Somente áudio PT-BR
          </label>
        </div>
      </div>
      <div class="mt-2 text-xs text-slate-400">
        Dica: acentos são ignorados na busca. Use <span class="mono">?dataset=URL</span> para carregar um dataset hospedado.
      </div>
    </section>

    <section id="dropZone" class="mb-6 border-2 border-dashed border-slate-700 rounded-2xl p-6 text-center hover:border-indigo-600 transition-colors">
      <p class="text-sm text-slate-300">Arraste & solte .vtt / .srt / .info.json / .json (ou deixe que o dataset hospedado carregue sozinho).</p>
      <p class="text-xs text-slate-500 mt-2">Para dataset hospedado, defina <span class="mono">DATASET_BASE</span> no código ou use <span class="mono">?dataset=URL</span> na URL.</p>
    </section>

    <section class="mb-4">
      <div id="stats" class="text-sm text-slate-400">0 vídeos • 0 trechos indexados</div>
      <div id="status" class="text-xs text-slate-400 mt-1"></div>
    </section>

    <section id="results" class="grid gap-3"></section>
  </div>

  <div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl w-full max-w-3xl shadow-xl">
      <div class="flex items-center justify-between p-3 border-b border-slate-800">
        <div class="text-sm text-slate-300" id="modalTitle"></div>
        <button id="modalClose" class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Fechar</button>
      </div>
      <div class="aspect-video">
        <iframe id="ytFrame" class="w-full h-full rounded-b-2xl" frameborder="0"
          allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
      </div>
    </div>
  </div>

<script>
let DATASET_BASE = ""; // e.g., "https://yourname.github.io/wow-ptbr-dataset"
const urlParams = new URLSearchParams(location.search);
if(urlParams.get("dataset")) DATASET_BASE = urlParams.get("dataset");
const MANIFEST = "manifest.json";

const $ = sel => document.querySelector(sel);
function stripAccents(s) { return s.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
function normalize(s) { return stripAccents(String(s||"")).toLowerCase().replace(/[^a-z0-9'\-\s]/g, " ").replace(/\s+/g, " ").trim(); }
function pad(n){ return n.toString().padStart(2,"0"); }
function secToHMS(sec){ sec = Math.max(0, Math.floor(sec)); const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60; return `${h>0?h+":":""}${pad(m)}:${pad(s)}`; }
function youtubeShortUrl(videoId, startSec){ return `https://youtu.be/${videoId}?t=${Math.max(0, Math.floor(startSec||0))}`; }
function youtubeEmbedUrl(videoId, startSec){ return `https://www.youtube.com/embed/${videoId}?start=${Math.max(0, Math.floor(startSec||0))}&autoplay=1`; }
function guessVideoIdFromName(name){ const base = name.split("/").pop(); const first = base.split(".")[0]; return first || null; }
function setStatus(msg){ $("#status").textContent = msg || ""; }

let META = new Map();
let CAPTIONS = [];
let AUDIO = new Map();

function renderStats(){
  const vids = new Set(CAPTIONS.map(c=>c.video_id)).size;
  $("#stats").textContent = `${vids} vídeos • ${CAPTIONS.length} trechos indexados • Áudio etiquetado: ${AUDIO.size}`;
}

// Heuristic audio
const PT_HINTS = ["dublado","dublagem","dublada","pt-br","brasil","cinemática","cinematica","trailer dublado","português","portugues"];
const EN_HINTS = ["developer update","dev update","deep dive","behind the scenes","entrevista","interview","q&a","qa","panel","painel","gameplay stream","stream","diário de desenvolvimento","diario de desenvolvimento","dev diary"];
function guessAudioLang(meta){
  const t = (meta.title_lc||"") + " " + (meta.desc_lc||"");
  const hasPT = PT_HINTS.some(k=> t.includes(k));
  const hasEN = EN_HINTS.some(k=> t.includes(k));
  if(hasPT && !hasEN) return "pt_guess";
  if(hasEN && !hasPT) return "en_guess";
  return "unknown";
}
function audioLabel(aud){
  if(aud.ann==="pt") return ["Áudio: PT-BR (confirmado)", "badge bg-green-900/40 text-green-200"];
  if(aud.ann==="en") return ["Áudio: EN (confirmado)", "badge bg-red-900/40 text-red-200"];
  if(aud.guess==="pt_guess") return ["Áudio: PT-BR (palpite)", "badge bg-emerald-900/30 text-emerald-200"];
  if(aud.guess==="en_guess") return ["Áudio: EN (palpite)", "badge bg-rose-900/30 text-rose-200"];
  return ["Áudio: desconhecido", "badge bg-slate-800 text-slate-300"];
}

// Parsers
function parseVTT(text){
  const lines = text.split(/\r?\n/);
  const cues = [];
  let start=null, end=null, buf=[];
  for(let i=0;i<lines.length;i++){
    const line = lines[i].trim();
    if(line.includes("-->")){
      const times = line.match(/(\d+:\d{2}:\d{2}\.\d{3})/g) || line.match(/(\d{2}:\d{2}\.\d{3})/g);
      function toSec(t){ const p=t.split(":"); if(p.length===3){return (+p[0])*3600 + (+p[1])*60 + parseFloat(p[2]);} if(p.length===2){return (+p[0])*60 + parseFloat(p[1]);} return 0; }
      if(times && times.length>=2){ start=toSec(times[0]); end=toSec(times[1]); buf=[]; }
    } else if(line==="" && start!=null){
      const txt = buf.join(" ").replace(/<[^>]+>/g,"").trim();
      if(txt) cues.push({start, end, text: txt});
      start=end=null; buf=[];
    } else if(start!=null){
      if(!/^(WEBVTT|NOTE)/i.test(line)) buf.push(line);
    }
  }
  if(start!=null && buf.length){
    const txt = buf.join(" ").replace(/<[^>]+>/g,"").trim();
    if(txt) cues.push({start, end, text: txt});
  }
  return cues;
}
function parseSRT(text){
  const lines = text.split(/\r?\n/);
  const cues=[]; let start=null,end=null,buf=[];
  for(let i=0;i<lines.length;i++){
    const line = lines[i].trim();
    if(/-->/.test(line)){
      const m = line.match(/(\d+):(\d{2}):(\d{2})[,.](\d{3})\s*-->\s*(\d+):(\d{2}):(\d{2})[,.](\d{3})/);
      if(m){
        const toSec = (h,mn,s,ms)=> (+h)*3600 + (+mn)*60 + (+s) + (+ms)/1000;
        start = toSec(m[1],m[2],m[3],m[4]);
        end   = toSec(m[5],m[6],m[7],m[8]);
        buf=[]; continue;
      }
    }
    if(line==="" && start!=null){
      const txt = buf.join(" ").trim();
      if(txt) cues.push({start,end,text:txt});
      start=end=null; buf=[]; continue;
    }
    if(/^\d+$/.test(line)) continue;
    if(start!=null) buf.push(line.replace(/<[^>]+>/g,""));
  }
  if(start!=null && buf.length){
    const txt = buf.join(" ").trim();
    if(txt) cues.push({start,end,text:txt});
  }
  return cues;
}

// Import / load
async function importFiles(fileList){
  let addedMeta=0, cuesAdded=0, annsAdded=0;
  setStatus("Importando...");
  for(const file of fileList){
    const name = file.name;
    const text = await file.text().catch(()=>null);
    if(!text) continue;
    if(name.endsWith(".info.json")){
      try{
        const data = JSON.parse(text);
        const id = data.id || guessVideoIdFromName(name);
        if(!id) continue;
        META.set(id, {
          title: data.title || "",
          channel: data.uploader || data.channel || "",
          published_at: (data.upload_date? `${data.upload_date.slice(0,4)}-${data.upload_date.slice(4,6)}-${data.upload_date.slice(6,8)}` : ""),
          url: data.webpage_url || `https://youtu.be/${id}`,
          title_lc: (data.title||"").toLowerCase(),
          desc_lc: (data.description||"").toLowerCase(),
        });
        addedMeta++;
      }catch(e){ console.error("JSON parse error", e); }
      continue;
    }
    if(name.endsWith(".vtt") || name.endsWith(".srt")){
      const id = guessVideoIdFromName(name);
      const lang = (name.split(".").slice(-2)[0] || "").toLowerCase();
      let cues = [];
      try{ cues = name.endsWith(".vtt") ? parseVTT(text) : parseSRT(text); }catch(e){ console.error("Caption parse error", e); }
      for(const cue of cues){
        CAPTIONS.push({video_id: id, lang, start: cue.start, end: cue.end, text: cue.text, source: "caption"});
        cuesAdded++;
      }
      continue;
    }
    if(name.endsWith(".json")){
      try{
        const data = JSON.parse(text);
        if(data && data.captions && data.meta){
          for(const [id, m] of data.meta){ META.set(id, m); }
          for(const c of data.captions){ CAPTIONS.push(c); }
          if(data.audio){ for(const [id, a] of data.audio){ AUDIO.set(id, a); } }
          annsAdded += (data.audio? data.audio.length : 0);
        } else if(Array.isArray(data) && data.length && (data[0].id || data[0].video_id)){
          for(const row of data){
            const id = row.id || row.video_id;
            const lang = row.audio_lang || row.lang || row.audio || "unknown";
            if(id) AUDIO.set(id, lang);
          }
          annsAdded += data.length;
        } else if (data && data.type === "shard"){
          for(const c of data.captions){ CAPTIONS.push(c); }
        }
      }catch(e){ console.error("Generic JSON parse error", e); }
      continue;
    }
  }
  renderStats();
  setStatus(`Importação: ${addedMeta} metadados, ${cuesAdded} trechos, ${annsAdded} anotações.`);
}

async function loadHostedDataset(){
  if(!DATASET_BASE) return;
  try{
    setStatus("Carregando dataset hospedado...");
    const mres = await fetch(`${DATASET_BASE.replace(/\/$/,'')}/${MANIFEST}`);
    if(!mres.ok) throw new Error("Manifest fetch failed");
    const manifest = await mres.json();

    if(Array.isArray(manifest.meta)){
      for(const [id, m] of manifest.meta){ META.set(id, m); }
    } else if (manifest.meta_url){
      const r = await fetch(manifest.meta_url); const data = await r.json();
      for(const [id, m] of data){ META.set(id, m); }
    }
    if(Array.isArray(manifest.audio)){
      for(const [id, a] of manifest.audio){ AUDIO.set(id, a); }
    } else if (manifest.audio_url){
      const r = await fetch(manifest.audio_url); const data = await r.json();
      for(const [id, a] of data){ AUDIO.set(id, a); }
    }
    renderStats();

    const shards = manifest.shards || [];
    for(const url of shards){
      const r = await fetch(url);
      const data = await r.json();
      if(data && data.type==="shard" && Array.isArray(data.captions)){
        for(const c of data.captions){ CAPTIONS.push(c); }
      }
    }
    renderStats();
    setStatus("Dataset hospedado carregado. Pesquise à vontade.");
  }catch(e){
    console.error(e);
    setStatus("Falha ao carregar dataset hospedado. Verifique a URL e CORS.");
  }
}

// Search
function search(query, opts={exact:false, strictPT:false}){
  const qn = normalize(query);
  if(!qn) return [];
  const results = [];
  for(const c of CAPTIONS){
    const meta = META.get(c.video_id) || {};
    const ann = AUDIO.get(c.video_id) || "unknown";
    const guess = guessAudioLang(meta);
    const isPT = (ann==="pt") || (ann==="unknown" && guess==="pt_guess");
    if(opts.strictPT && !isPT) continue;

    const tn = normalize(c.text);
    const hit = opts.exact
      ? (tn.split(/\b/).includes(qn) || tn.includes(` ${qn} `) || tn.startsWith(qn+" ") || tn.endsWith(" "+qn))
      : tn.includes(qn);
    if(!hit) continue;

    results.push({
      ...c,
      title: meta.title || c.video_id,
      channel: meta.channel || "",
      published_at: meta.published_at || "",
      url: (meta.url || `https://youtu.be/${c.video_id}`),
      _aud: { ann, guess, isPT }
    });
  }
  results.sort((a,b)=>{
    const ar = (a._aud.ann==="pt" ? 2 : a._aud.guess==="pt_guess" ? 1 : 0);
    const br = (b._aud.ann==="pt" ? 2 : b._aud.guess==="pt_guess" ? 1 : 0);
    if(ar!==br) return br - ar;
    const da = a.published_at || "", db = b.published_at || "";
    if(da!==db) return db.localeCompare(da);
    return a.start - b.start;
  });
  return results.slice(0, 200);
}

function renderResults(items){
  const root = $("#results");
  root.innerHTML = "";
  if(!items.length){
    root.innerHTML = `<div class="text-slate-400 text-sm">Nenhum resultado. Tente variações ou desmarque filtros.</div>`;
    return;
  }
  for(const it of items){
    const url = youtubeShortUrl(it.video_id, it.start);
    const [label, klass] = (function(aud){
      if(aud.ann==="pt") return ["Áudio: PT-BR (confirmado)", "badge bg-green-900/40 text-green-200"];
      if(aud.ann==="en") return ["Áudio: EN (confirmado)", "badge bg-red-900/40 text-red-200"];
      if(aud.guess==="pt_guess") return ["Áudio: PT-BR (palpite)", "badge bg-emerald-900/30 text-emerald-200"];
      if(aud.guess==="en_guess") return ["Áudio: EN (palpite)", "badge bg-rose-900/30 text-rose-200"];
      return ["Áudio: desconhecido", "badge bg-slate-800 text-slate-300"];
    })({ann: (AUDIO.get(it.video_id)||"unknown"), guess: guessAudioLang(META.get(it.video_id)||{})});
    const card = document.createElement("div");
    card.className = "rounded-2xl border border-slate-800 bg-slate-900 p-4";
    card.innerHTML = `
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="flex items-center gap-2 flex-wrap">
            <div class="text-sm text-slate-400">${it.channel || "Canal"}</div>
            <span class="${klass}">${label}</span>
          </div>
          <div class="font-semibold mt-1">${it.title}</div>
          <div class="text-xs text-slate-500">${it.published_at || ""} • ${it.lang || ""}</div>
        </div>
        <div class="text-right text-sm">
          <div class="mono text-slate-400">${secToHMS(it.start)} → ${secToHMS(it.end)}</div>
          <a href="${url}" target="_blank" class="inline-block mt-1 text-indigo-400 underline">Abrir no YouTube</a>
        </div>
      </div>
      <div class="mt-3 text-slate-200 line-clamp-3">${it.text.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
      <div class="mt-3 flex gap-2">
        <button data-act="play" data-id="${it.video_id}" data-start="${Math.floor(it.start)}"
          class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-sm">Reproduzir aqui</button>
        <button data-act="copy" data-url="${url}"
          class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm">Copiar link</button>
      </div>
    `;
    root.appendChild(card);
  }
  root.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-act");
      if(act==="copy"){
        const link = btn.getAttribute("data-url");
        navigator.clipboard.writeText(link); setStatus("Link copiado!");
      } else if(act==="play"){
        const vid = btn.getAttribute("data-id");
        const start = +btn.getAttribute("data-start") || 0;
        document.getElementById("modal").classList.remove("hidden");
        document.getElementById("modal").classList.add("flex");
        document.getElementById("ytFrame").src = youtubeEmbedUrl(vid, start);
        document.getElementById("modalTitle").textContent = `Prévia — ${vid} @ ${secToHMS(start)}`;
      }
    });
  });
}

document.getElementById("btnImport").addEventListener("click", ()=> document.getElementById("fileInput").click());
document.getElementById("fileInput").addEventListener("change", (e)=> importFiles(e.target.files));

const dz = document.getElementById("dropZone");
dz.addEventListener("dragover", e=>{ e.preventDefault(); dz.classList.add("border-indigo-600"); });
dz.addEventListener("dragleave", ()=> dz.classList.remove("border-indigo-600"));
dz.addEventListener("drop", e=>{ e.preventDefault(); dz.classList.remove("border-indigo-600"); const files = e.dataTransfer.files; if(files && files.length) importFiles(files); });

function doSearch(){
  const q = document.getElementById("searchBox").value.trim();
  const exact = document.getElementById("exactMatch").checked;
  const strictPT = document.getElementById("strictPT").checked;
  const items = search(q, {exact, strictPT});
  renderResults(items);
}
document.getElementById("btnSearch").addEventListener("click", doSearch);
document.getElementById("searchBox").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doSearch(); });
document.getElementById("exactMatch").addEventListener("change", doSearch);
document.getElementById("strictPT").addEventListener("change", doSearch);

document.getElementById("btnExport").addEventListener("click", ()=>{
  const payload = { meta: [...META.entries()], captions: CAPTIONS, audio: [...AUDIO.entries()] };
  const blob = new Blob([JSON.stringify(payload)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = "corpus_export_with_audio.json"; a.click(); URL.revokeObjectURL(a.href);
});

document.getElementById("btnClear").addEventListener("click", ()=>{
  if(confirm("Limpar índice local?")){
    META = new Map(); CAPTIONS = []; AUDIO = new Map();
    document.getElementById("results").innerHTML = "";
    renderStats();
    setStatus("Índice limpo.");
  }
});

document.getElementById("modalClose").addEventListener("click", ()=>{
  const modal = document.getElementById("modal");
  modal.classList.add("hidden"); modal.classList.remove("flex");
  document.getElementById("ytFrame").src = "";
});

window.addEventListener("load", ()=>{
  if(DATASET_BASE){
    loadHostedDataset().then(()=> setStatus("Pronto. Digite um termo e pesquise."));
  } else {
    setStatus("Dica: passe ?dataset=URL para carregar dataset hospedado automaticamente.");
  }
  renderStats();
});
</script>
</body>
</html>
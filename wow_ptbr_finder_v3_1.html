<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buscador de pronúncia PTBR World of Warcraft</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .line-clamp-3 {display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
    .mono {font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Buscador de pronúncia PTBR World of Warcraft</h1>
      <p class="text-sm text-slate-400">Desenvolvido por Lucas Peixoto SIW</p>
    </header>

    <section class="mb-4">
      <div class="grid md:grid-cols-3 gap-3 items-center">
        <div class="md:col-span-2 flex items-center gap-2">
          <input id="searchBox" type="text"
            placeholder="Procure por um termo no universo de WoW para ver sua pronúncia"
            class="w-full px-4 py-3 rounded-2xl bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-600" />
          <button id="btnSearch" class="px-4 py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Buscar</button>
        </div>
        <div class="text-sm text-slate-300">
          <div id="counter" class="text-right md:text-left">0 vídeos</div>
        </div>
      </div>
    </section>

    <section class="mb-4">
      <div>
        <div class="text-sm text-slate-300 font-semibold mb-2">Filtrar por canal</div>
        <div id="channelFilters" class="flex flex-wrap gap-2"></div>
      </div>
    </section>

    <section class="mb-2">
      <div id="status" class="text-xs text-slate-400"></div>
    </section>

    <section id="results" class="grid gap-3"></section>
  </div>

  <!-- Modal Player -->
  <div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl w-full max-w-3xl shadow-xl">
      <div class="flex items-center justify-between p-3 border-b border-slate-800">
        <div class="text-sm text-slate-300" id="modalTitle"></div>
        <button id="modalClose" class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">Fechar</button>
      </div>
      <div class="aspect-video">
        <iframe id="ytFrame" class="w-full h-full rounded-b-2xl" frameborder="0"
          allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
      </div>
    </div>
  </div>

<script>
// ===== Config =====
const CLIPPER_URL = "https://colab.research.google.com/github/lucaspeixototrad-boop/wow-ptbr-dataset/blob/tools/WoW_PTBR_Audio_Clipper_OneClick.ipynb";
const CLIP_DEFAULT_SEC = 5;
let DATASET_BASE = "";
const urlParams = new URLSearchParams(location.search);
if (urlParams.get("dataset")) DATASET_BASE = urlParams.get("dataset");
const MANIFEST = "manifest.json";

// ===== Helpers =====
const $ = sel => document.querySelector(sel);
function stripAccents(s) { return s.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
function normalize(s) { return stripAccents(String(s||"")).toLowerCase().replace(/[^a-z0-9'\-\s]/g, " ").replace(/\s+/g, " ").trim(); }
function pad(n){ return n.toString().padStart(2,"0"); }
function secToHMS(sec){ sec = Math.max(0, Math.floor(sec)); const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60; return `${h>0?h+":":""}${pad(m)}:${pad(s)}`; }
function youtubeShortUrl(videoId, startSec){ return `https://youtu.be/${videoId}?t=${Math.max(0, Math.floor(startSec||0))}`; }
function youtubeEmbedUrl(videoId, startSec){ return `https://www.youtube.com/embed/${videoId}?start=${Math.max(0, Math.floor(startSec||0))}&autoplay=1`; }
function setStatus(msg){ $("#status").textContent = msg || ""; }

// Robust URL resolver: works with absolute bases (http...) and relative (., ..)
function toAbsoluteUrl(base, path) {
  try {
    if (/^(https?:)?\/\//i.test(path)) return path;
    if (/^(https?:)?\/\//i.test(base)) {
      const b = base.endsWith('/') ? base : base + '/';
      return new URL(path, b).href;
    }
    const baseAbs = new URL(base || '.', location.href).href;
    const b2 = baseAbs.endsWith('/') ? baseAbs : baseAbs + '/';
    return new URL(path, b2).href;
  } catch (e) {
    return path;
  }
}

// ===== Data =====
let META = new Map();      // video_id -> meta
let CAPTIONS = [];         // list of {video_id, lang, start, end, text}
let CHANNELS = new Set();  // set of channel names
let ACTIVE_CHANNELS = new Set(); // filtered channels

function renderCounter() {
  const vids = new Set(CAPTIONS.map(c=>c.video_id)).size;
  $("#counter").textContent = `${vids} vídeos`;
}

function buildChannelFilters() {
  CHANNELS = new Set();
  for (const [id, meta] of META.entries()) {
    const ch = (meta.channel || "").trim() || "Sem canal";
    CHANNELS.add(ch);
  }
  const container = $("#channelFilters");
  container.innerHTML = "";
  ACTIVE_CHANNELS = new Set(CHANNELS); // pré-selecionadas
  for (const ch of Array.from(CHANNELS).sort((a,b)=>a.localeCompare(b))) {
    const id = "ch_" + ch.replace(/[^a-z0-9]+/gi, "_");
    const label = document.createElement("label");
    label.className = "inline-flex items-center gap-2 text-sm bg-slate-900 border border-slate-700 px-3 py-2 rounded-xl";
    label.innerHTML = `<input type="checkbox" id="${id}" class="accent-indigo-600" checked> <span>${ch}</span>`;
    container.appendChild(label);
    const cb = label.querySelector("input");
    cb.addEventListener("change", () => {
      if (cb.checked) ACTIVE_CHANNELS.add(ch); else ACTIVE_CHANNELS.delete(ch);
      doSearch(); // atualizar resultados conforme filtro
    });
  }
}

// ===== Load hosted dataset =====
async function loadHostedDataset(){
  if(!DATASET_BASE) return;
  try {
    const manifestUrl = toAbsoluteUrl(DATASET_BASE, MANIFEST);
    setStatus("Carregando manifest: " + manifestUrl);
    const mres = await fetch(manifestUrl, {mode:"cors"});
    if (!mres.ok) throw new Error("Manifest HTTP " + mres.status);
    const manifest = await mres.json();

    // meta
    if (manifest.meta_url) {
      const mu = toAbsoluteUrl(DATASET_BASE, manifest.meta_url);
      const r = await fetch(mu, {mode:"cors"});
      if (!r.ok) throw new Error("Meta HTTP " + r.status);
      const data = await r.json();
      for (const [id, m] of data) { META.set(id, m); }
    } else if (Array.isArray(manifest.meta)) {
      for (const [id, m] of manifest.meta) { META.set(id, m); }
    }

    // shards
    const shards = manifest.shards || [];
    let ok=0, fail=0;
    for (const path of shards) {
      const su = toAbsoluteUrl(DATASET_BASE, path);
      try {
        const r = await fetch(su, {mode:"cors"});
        if (!r.ok) { fail++; continue; }
        const d = await r.json();
        if (d && d.type==="shard" && Array.isArray(d.captions)) {
          for (const c of d.captions) { CAPTIONS.push(c); }
          ok++; setStatus(`Shards: ${ok}/${shards.length} carregados (${fail} falhas)`);
        } else { fail++; }
      } catch(e) { fail++; }
    }
    buildChannelFilters();
    renderCounter();
    if (fail>0) setStatus(`Concluído com avisos. Shards OK: ${ok}, falhas: ${fail}.`);
    else setStatus("Dataset carregado. Faça uma busca.");
  } catch(e) {
    console.error(e);
    setStatus("Falha ao carregar dataset. Dica: hospede esta página no mesmo domínio do dataset e use ?dataset=.");
  }
}

// ===== Search =====
function search(query) {
  const qn = normalize(query);
  if (!qn) return [];
  const results = [];
  for (const c of CAPTIONS) {
    const meta = META.get(c.video_id) || { };
    const ch = (meta.channel || "").trim() || "Sem canal";
    if (!ACTIVE_CHANNELS.has(ch)) continue;

    const tn = normalize(c.text);
    if (!tn.includes(qn)) continue;

    results.push({
      ...c,
      title: meta.title || c.video_id,
      channel: ch,
      published_at: meta.published_at || "",
      url: (meta.url || `https://youtu.be/${c.video_id}`)
    });
  }
  results.sort((a,b)=>{ const da=a.published_at||"", db=b.published_at||""; if(da!==db) return db.localeCompare(da); return a.start-b.start; });
  return results.slice(0, 200);
}

function renderResults(items){
  const root = $("#results");
  root.innerHTML = "";
  if(!items.length){
    root.innerHTML = `<div class="text-slate-400 text-sm">Nenhum resultado.</div>`;
    return;
  }
  for(const it of items){
    const url = youtubeShortUrl(it.video_id, it.start);
    const card = document.createElement("div");
    card.className = "rounded-2xl border border-slate-800 bg-slate-900 p-4";
    card.innerHTML = `
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-sm text-slate-400">${it.channel}</div>
          <div class="font-semibold mt-1">${it.title}</div>
          <div class="text-xs text-slate-500">${it.published_at || ""} • ${it.lang || ""}</div>
        </div>
        <div class="text-right text-sm">
          <div class="mono text-slate-400">${secToHMS(it.start)} → ${secToHMS(it.end)}</div>
        </div>
      </div>
      <div class="mt-3 text-slate-200 line-clamp-3">${it.text.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button data-act="play" data-id="${it.video_id}" data-start="${Math.floor(it.start)}"
          class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-sm">Reproduzir aqui</button>
        <button data-act="clip" data-id="${it.video_id}" data-start="${Math.floor(it.start)}"
          class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm">Baixar áudio (ferramenta externa)</button>
        <a href="${url}" target="_blank"
          class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm inline-block">Abrir no YouTube</a>
      </div>
    `;
    root.appendChild(card);
  }
  root.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-act");
      if(act==="play"){
        const vid = btn.getAttribute("data-id");
        const start = +btn.getAttribute("data-start") || 0;
        document.getElementById("modal").classList.remove("hidden");
        document.getElementById("modal").classList.add("flex");
        document.getElementById("ytFrame").src = youtubeEmbedUrl(vid, start);
        document.getElementById("modalTitle").textContent = `Prévia — ${vid} @ ${secToHMS(start)}`;
      } else if(act==="clip"){
        const vid = btn.getAttribute("data-id");
        const start = +btn.getAttribute("data-start") || 0;
        const spec = `https://youtu.be/${vid}?t=${start} | ${CLIP_DEFAULT_SEC}s`;
        navigator.clipboard.writeText(spec).then(()=> {
          setStatus("Especificação do clipe copiada. Abrindo ferramenta externa...");
          window.open(CLIPPER_URL, "_blank");
        });
      }
    });
  });
}

function doSearch(){
  const q = $("#searchBox").value.trim();
  const items = search(q);
  renderResults(items);
}

document.getElementById("btnSearch").addEventListener("click", doSearch);
document.getElementById("searchBox").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doSearch(); });

document.getElementById("modalClose").addEventListener("click", ()=>{
  const modal = document.getElementById("modal");
  modal.classList.add("hidden"); modal.classList.remove("flex");
  document.getElementById("ytFrame").src = "";
});

// Boot
window.addEventListener("load", ()=>{
  if(DATASET_BASE){
    loadHostedDataset().then(()=> setStatus(""));
  } else {
    setStatus("Dica: passe ?dataset=URL ou use ?dataset=. (mesma pasta)");
  }
  renderCounter();
});
</script>
</body>
</html>